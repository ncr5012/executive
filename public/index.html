<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Executive</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', 'Fira Code', monospace;
    background: #0a0a0a;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 24px;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 1px solid #222;
  }
  h1 { font-size: 20px; font-weight: 600; letter-spacing: 4px; color: #fff; }
  .btn {
    padding: 8px 16px;
    border: 1px solid #333;
    background: #1a1a1a;
    color: #ccc;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    border-radius: 4px;
  }
  .btn:hover { background: #252525; border-color: #444; }
  .btn-green { border-color: #2a5a2a; color: #4ade80; }
  .btn-green:hover { background: #1a2e1a; }

  .section-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin: 24px 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .dot-green { background: #4ade80; box-shadow: 0 0 8px #4ade8066; }
  .dot-red { background: #f87171; box-shadow: 0 0 8px #f8717166; }
  .dot-yellow { background: #facc15; box-shadow: 0 0 8px #facc1566; }

  .task-list { display: flex; flex-direction: column; gap: 6px; }

  .task {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 6px;
    background: #111;
    border: 1px solid #1a1a1a;
  }
  .task-done { background: #0a1a0a; border-color: #1a3a1a; }
  .task-working { background: #1a0a0a; border-color: #3a1a1a; }
  .task-queued { background: #1a1a0a; border-color: #3a3a1a; }

  .task-icon { font-size: 18px; flex-shrink: 0; }

  .task-info { flex: 1; min-width: 0; }
  .task-title {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .task-title-input {
    background: transparent;
    border: none;
    border-bottom: 1px solid #444;
    color: #e0e0e0;
    font-family: inherit;
    font-size: 14px;
    width: 100%;
    outline: none;
  }
  .task-meta {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
    display: flex;
    gap: 12px;
  }

  .badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 3px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    flex-shrink: 0;
  }
  .badge-urgent { background: #7f1d1d; color: #fca5a5; }
  .badge-important { background: #14532d; color: #4ade80; }
  .badge-routine { background: #1e1e1e; color: #888; }
  .badge.clickable { cursor: pointer; }
  .badge.clickable:hover { opacity: 0.7; }
  .badge-machine {
    background: #1e293b;
    color: #93c5fd;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 3px;
  }

  .toggle-wrap {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }
  .toggle-label { font-size: 10px; color: #666; letter-spacing: 1px; text-transform: uppercase; }
  .toggle {
    width: 36px; height: 20px;
    background: #333;
    border-radius: 10px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
  }
  .toggle.on { background: #166534; box-shadow: 0 0 12px #4ade8044; }
  .toggle::after {
    content: '';
    position: absolute;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: #888;
    top: 2px; left: 2px;
    transition: all 0.2s;
  }
  .toggle.on::after { left: 18px; background: #4ade80; }


  .delete-btn {
    font-size: 14px;
    background: none;
    border: none;
    color: #444;
    cursor: pointer;
    padding: 4px;
  }
  .delete-btn:hover { color: #f87171; }

  .empty { color: #444; font-size: 13px; padding: 12px 16px; }

  /* New task form */
  .new-task-form {
    display: none;
    gap: 8px;
    padding: 16px;
    background: #111;
    border: 1px solid #222;
    border-radius: 6px;
    margin-bottom: 16px;
  }
  .new-task-form.open { display: flex; flex-wrap: wrap; }
  .new-task-form input {
    flex: 1;
    min-width: 200px;
    padding: 8px 12px;
    background: #0a0a0a;
    border: 1px solid #333;
    color: #e0e0e0;
    font-family: inherit;
    font-size: 13px;
    border-radius: 4px;
    outline: none;
  }
  .new-task-form input:focus { border-color: #555; }
  .new-task-form select {
    padding: 8px 12px;
    background: #0a0a0a;
    border: 1px solid #333;
    color: #e0e0e0;
    font-family: inherit;
    font-size: 13px;
    border-radius: 4px;
  }

  #connection-status {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #f87171;
    display: inline-block;
  }
  #connection-status.connected { background: #4ade80; }
</style>
</head>
<body>

<header>
  <h1>EXECUTIVE <span id="connection-status" title="Disconnected"></span></h1>
</header>


<div id="taskContainer"></div>

<script>
const API_KEY_HEADER = {}; // Browser doesn't need API key for local access

let tasks = [];
let audioCtx = null;

// --- Audio ---
function playChime() {
  if (!audioCtx) audioCtx = new AudioContext();
  const now = audioCtx.currentTime;

  // Two-tone chime
  [523.25, 659.25].forEach((freq, i) => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0.3, now + i * 0.15);
    gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.5);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(now + i * 0.15);
    osc.stop(now + i * 0.15 + 0.5);
  });
}

// --- SSE ---
function connectSSE() {
  const status = document.getElementById('connection-status');
  const es = new EventSource('/api/events');
  es.onopen = () => { status.className = 'connected'; status.title = 'Connected'; };
  es.onerror = () => {
    status.className = '';
    status.title = 'Disconnected';
    setTimeout(connectSSE, 3000);
    es.close();
  };

  es.addEventListener('task-created', e => {
    const task = JSON.parse(e.data);
    const existing = tasks.find(t => t.id === task.id);
    if (!existing) tasks.push(task);
    render();
  });

  es.addEventListener('task-complete', e => {
    const task = JSON.parse(e.data);
    const idx = tasks.findIndex(t => t.id === task.id);
    if (idx >= 0) tasks[idx] = task;
    else tasks.push(task);
    playChime();
    render();
  });

  es.addEventListener('task-updated', e => {
    const task = JSON.parse(e.data);
    const idx = tasks.findIndex(t => t.id === task.id);
    if (idx >= 0) tasks[idx] = task;
    render();
  });

  es.addEventListener('task-deleted', e => {
    const { id } = JSON.parse(e.data);
    tasks = tasks.filter(t => t.id !== id);
    render();
  });
}

// --- Render ---
function sortTasks(tasks) {
  const order = { 'done': 0, 'working': 1, 'queued': 2 };
  const tierOrder = { 'urgent': 0, 'important': 1, 'routine': 2 };
  return [...tasks].sort((a, b) => {
    const sa = order[a.status] ?? 3;
    const sb = order[b.status] ?? 3;
    if (sa !== sb) return sa - sb;
    const ta = tierOrder[a.tier] ?? 1;
    const tb = tierOrder[b.tier] ?? 1;
    if (ta !== tb) return ta - tb;
    return new Date(b.createdAt) - new Date(a.createdAt);
  });
}

function timeAgo(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  return Math.floor(hrs / 24) + 'd ago';
}

function elapsed(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return '<1m';
  if (mins < 60) return mins + 'm';
  const hrs = Math.floor(mins / 60);
  return hrs + 'h ' + (mins % 60) + 'm';
}

function render() {
  const container = document.getElementById('taskContainer');
  const sorted = sortTasks(tasks);

  const done = sorted.filter(t => t.status === 'done');
  const working = sorted.filter(t => t.status === 'working');
  const queued = sorted.filter(t => t.status === 'queued');

  let html = '';

  // Done section
  html += `<div class="section-label"><span class="dot dot-green"></span> DONE (${done.length})</div>`;
  html += '<div class="task-list">';
  if (done.length === 0) html += '<div class="empty">No completed tasks</div>';
  done.forEach(t => {
    html += `
      <div class="task task-done">
        <div class="task-icon">&#9989;</div>
        <div class="task-info">
          <div class="task-title" ondblclick="editTitle(this, '${t.id}')">${esc(t.title)}</div>
          <div class="task-meta">
            <span>Completed ${timeAgo(t.completedAt)}</span>
            ${t.cwd ? '<span>' + esc(t.cwd) + '</span>' : ''}
          </div>
        </div>
        <span class="badge badge-${t.tier} clickable" onclick="toggleTier('${t.id}', '${t.tier}')">${t.tier}</span>
        <span class="badge badge-machine">${esc(t.machine)}</span>
      </div>`;
  });
  html += '</div>';

  // Working section
  html += `<div class="section-label"><span class="dot dot-red"></span> WORKING (${working.length})</div>`;
  html += '<div class="task-list">';
  if (working.length === 0) html += '<div class="empty">No active tasks</div>';
  working.forEach(t => {
    html += `
      <div class="task task-working">
        <div class="task-icon" style="color:#f87171">&#9679;</div>
        <div class="task-info">
          <div class="task-title" ondblclick="editTitle(this, '${t.id}')">${esc(t.title)}</div>
          <div class="task-meta">
            <span>Running ${elapsed(t.startedAt)}</span>
            ${t.cwd ? '<span>' + esc(t.cwd) + '</span>' : ''}
          </div>
        </div>
        <span class="badge badge-${t.tier} clickable" onclick="toggleTier('${t.id}', '${t.tier}')">${t.tier}</span>
        <span class="badge badge-machine">${esc(t.machine)}</span>
        <div class="toggle-wrap">
          <span class="toggle-label">Auto</span>
          <div class="toggle ${t.autopilot ? 'on' : ''}" onclick="toggleAutopilot('${t.id}', ${!t.autopilot})"></div>
        </div>
      </div>`;
  });
  html += '</div>';

  // Queued section
  if (queued.length > 0) {
    html += `<div class="section-label"><span class="dot dot-yellow"></span> QUEUED (${queued.length})</div>`;
    html += '<div class="task-list">';
    queued.forEach(t => {
      html += `
        <div class="task task-queued">
          <div class="task-icon" style="color:#facc15">&#9203;</div>
          <div class="task-info">
            <div class="task-title">${esc(t.title)}</div>
            <div class="task-meta"><span>Waiting for claim</span></div>
          </div>
          <span class="badge badge-${t.tier} clickable" onclick="toggleTier('${t.id}', '${t.tier}')">${t.tier}</span>
          <span class="badge badge-machine">${esc(t.machine)}</span>
        </div>`;
    });
    html += '</div>';
  }

  container.innerHTML = html;
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// --- Actions ---
async function apiFetch(url, opts = {}) {
  return fetch(url, { ...opts, headers: { 'Content-Type': 'application/json', ...opts.headers } });
}

async function toggleAutopilot(id, val) {
  await apiFetch(`/api/tasks/${id}`, { method: 'PATCH', body: JSON.stringify({ autopilot: val }) });
}

async function toggleTier(id, current) {
  const cycle = { 'routine': 'important', 'important': 'urgent', 'urgent': 'routine' };
  const next = cycle[current] || 'routine';
  await apiFetch(`/api/tasks/${id}`, { method: 'PATCH', body: JSON.stringify({ tier: next }) });
}


function editTitle(el, id) {
  const current = el.textContent;
  el.innerHTML = `<input class="task-title-input" value="${esc(current)}" onblur="saveTitle(this, '${id}')" onkeydown="if(event.key==='Enter')this.blur()">`;
  el.querySelector('input').focus();
}

async function saveTitle(input, id) {
  const title = input.value.trim();
  if (title) {
    await apiFetch(`/api/tasks/${id}`, { method: 'PATCH', body: JSON.stringify({ title }) });
  }
}


// --- Init ---
async function init() {
  // Enable audio on first click
  document.addEventListener('click', () => {
    if (!audioCtx) audioCtx = new AudioContext();
  }, { once: true });

  const res = await apiFetch('/api/tasks');
  const data = await res.json();
  tasks = data.tasks;
  render();
  connectSSE();

  // Re-render every 30s to update elapsed times
  setInterval(render, 30000);
}

init();
</script>
</body>
</html>
